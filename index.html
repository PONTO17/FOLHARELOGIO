<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro, Lista e Impressão (Google Sheets Automático)</title>

  <style>
    /* ---------- CSS ---------- */
    *{box-sizing:border-box;font-family:Arial, sans-serif}
    body{margin:20px;background:#f9f9f9}
    h2,h3,h4{margin:5px 0}

    .container-form{width:100%;background:#fff;border:1px solid #ccc;
                    padding:15px;margin-bottom:20px}
    .container-form h3{margin-bottom:15px}
    .container-form label{display:block;margin-bottom:5px;font-weight:bold}
    .container-form input,.container-form textarea{width:100%;padding:8px;margin-bottom:10px}

    #search-container{display:none;background:#fff;border:1px solid #ccc;
                      padding:15px;margin-bottom:20px}

    .botao-nova-aba{position:fixed;right:10px;top:50px;padding:10px 15px;
                    font-weight:bold;cursor:pointer;background:#007BFF;color:#fff;
                    border:none;border-radius:4px;display:none}

    table{width:100%;border-collapse:collapse;margin-bottom:20px}
    table,th,td{border:1px solid #ccc}
    th,td{padding:8px;text-align:center}

    .linha-concluida{background:#ccffcc!important}

    .pay-bullet{display:inline-block;width:12px;height:12px;border-radius:50%;
                margin-left:5px;vertical-align:middle}

    .editing-input{width:95%;background:#fffbe2;border:1px solid #ccc}

    .radio-group{margin-bottom:10px}
    .radio-group span{font-weight:bold;margin-right:10px}
    .radio-group input[type="radio"]{display:none}
    .radio-group .radio-btn{display:inline-block;padding:8px 16px;margin-right:5px;
                            border:1px solid #ccc;border-radius:4px;background:#f0f0f0;
                            cursor:pointer;transition:.3s}
    .radio-group input[type="radio"]:checked + .radio-btn{
      background:#007BFF;color:#fff;border-color:#007BFF}

    .impressao{display:none;position:absolute;left:-9999px;top:-9999px}

    @media print{
      body *{visibility:hidden!important}
      .impressao,.impressao *{visibility:visible!important}
      .impressao{display:block!important;position:fixed!important;top:0;left:0;width:100%!important}
    }
  </style>
</head>

<body>
<h2>Cadastro e Impressão (Google Sheets Automático)</h2>

<script>
  /* ------------ SUA URL DO APPS SCRIPT ------------ */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxGJjSqGxx10bDDRS5l1PloX-xuPmotTxQ704cc1j9v_VwKC5Y0i_E0-5Nmta_-LFzMnQ/exec";
</script>

<!-- ======== FORMULÁRIO ======== -->
<div class="container-form">
  <h3>Cadastro</h3>

  <label>Nome:</label>
  <input id="cad-nome" placeholder="Ex: Marcos Antônio">

  <label>Telefone:</label>
  <input id="cad-telefone" placeholder="Ex: (xx) 99999-9999">

  <label>Objetos:</label>
  <input id="cad-servico" placeholder="Ex: Relógio (marca) dourado">

  <label>DESCRIÇÃO DO SERVIÇO:</label>
  <textarea id="cad-obs" rows="3" placeholder="Ex: Troca de bateria e limpeza interna"></textarea>

  <label>Quantos dias úteis?</label>
  <input id="cad-dias-uteis" type="number" placeholder="Ex: 5">

  <div class="radio-group">
    <span>É orçamento?</span>
    <input type="radio" id="orcamentoSim" name="orcamento" value="sim">
    <label for="orcamentoSim" class="radio-btn" onclick="toggleValorField()">SIM</label>
    <input type="radio" id="orcamentoNao" name="orcamento" value="nao" checked>
    <label for="orcamentoNao" class="radio-btn" onclick="toggleValorField()">NÃO</label>
  </div>

  <div id="cad-valor-field">
    <label>Valor (R$):</label>
    <input id="cad-valor" placeholder="Ex: 150,00">
  </div>

  <button onclick="confirmarCadastro()">Confirmar & Imprimir</button>
  <button id="btnLimpar" onclick="limparCadastro()">Limpar</button>
</div>

<button onclick="toggleSearch()">BUSCAR SERVIÇO</button>
<div id="search-container">
  <h3>Buscar</h3>
  <input id="searchTerm" placeholder="Digite nome, telefone ou objeto">
  <button onclick="searchServices()">Buscar</button>
</div>

<h3>Lista de Cadastros</h3>
<table id="lista-cadastros">
  <thead>
    <tr>
      <th>Nº</th><th>Nome</th><th>Telefone</th><th>Objetos</th><th>Entrada</th>
      <th>Volta</th><th>Valor (R$)</th><th>Pagou?</th><th>Status</th><th>Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button class="botao-nova-aba" id="btnNovaAba" onclick="abrirFolhaEmNovaAba()">Abrir Folha de Impressão</button>

<!-- ====== FOLHA DE IMPRESSÃO ====== -->
<div class="impressao" id="folha-impressao">
  <div class="recibo-header" style="display:flex;justify-content:space-between;border-bottom:2px solid #000;padding-bottom:5px;margin-bottom:10px">
    <div><h3>PONTO 17</h3><p>Telefones: 3349-3318 / 3229-8972</p></div>
    <div><h3>Nº <span id="print-id">__</span></h3></div>
  </div>

  <h3>Serviços Rápidos</h3>
  <div class="recibo-info">
    <div><label>Nome: </label><span id="print-nome"></span></div>
    <div><label>Telefone: </label><span id="print-telefone"></span></div>
    <div><label>Objetos: </label><span id="print-servico"></span></div>
    <div><label>DESCRIÇÃO DO SERVIÇO: </label><span id="print-obs"></span></div>
  </div>

  <hr>
  <h4>OBJETO/ORÇAMENTO</h4>
  <div class="recibo-info">
    <div><label>Valor (R$): </label><span id="print-valor">___</span></div>
    <div><label>Data Entrada: </label><span id="print-data-entrada">__/__/__</span></div>
    <div><label>Data Retirada: </label><span id="print-data-retirada">__/__/__</span></div>
    <div><label>Garantia até: </label><span id="print-garantia">__</span></div>
    <p style="margin-top:10px">
      OBS: ESTOU CIENTE E DE ACORDO COM A ORIENTAÇÃO DO PROCON QUE OS APARELHOS
      NÃO RETIRADOS NO PRAZO MÁXIMO DE 30 DIAS SERÃO COBRADOS UMA TAXA DE
      ARMAZENAMENTO DE R$ 1,00 (UM REAL), E NO MÁXIMO 90 DIAS SERÃO VENDIDOS
      PARA COBRIR CUSTOS OPERACIONAIS, MESMO OS SERVIÇOS, JÁ SENDO PAGOS E/OU
      SINAL DE 50%.
    </p>
  </div>

  <div style="display:flex;justify-content:space-between;margin-top:40px">
    <div>___________________________<br>Assinatura Cliente</div>
    <div>___________________________<br>Assinatura Funcionário Responsável</div>
  </div>
</div>

<!-- ================= JAVASCRIPT COMPLETO ================= -->
<script>
window.addEventListener('load', carregarDoGoogle);
let registroCount = 1;

/* --------- Helpers básicos --------- */
function toggleValorField(){
  document.getElementById('cad-valor-field').style.display =
    document.getElementById('orcamentoSim').checked ? 'none' : 'block';
}
function formatarValor(v){
  const n = parseFloat(v.replace(',','.'));
  return isNaN(n) ? '___' : n.toFixed(2).replace('.',',');
}
function parseDate(d){
  const p = d.split('/');
  return p.length===3 ? new Date(+p[2],+p[1]-1,+p[0]) : new Date(0);
}
function getStatusRank(s){return s==="EM ORÇAMENTO"?0:s==="EM CONSERTO"?1:s==="CONCLUIDO"?2:9;}
function updateRowStyleStatus(row,s){
  s==="CONCLUIDO" ? row.classList.add('linha-concluida')
                  : row.classList.remove('linha-concluida');
}

/* --------- Funções de edição inline --------- */
function createEditableCell(row,i,text){
  const c=row.insertCell(i); c.textContent=text;
}
function makeCellEditable(c){
  const v=c.textContent; c.textContent='';
  const inp=document.createElement('input');
  inp.value=v; inp.className='editing-input'; c.appendChild(inp);
}
function finalizeCellEdit(c){
  const inp=c.querySelector('input'); if(inp) c.textContent=inp.value;
}

/* --------- Construção da tabela --------- */
function preencherTabela(arr){
  const tb=document.querySelector('#lista-cadastros tbody'); tb.innerHTML='';
  registroCount=1;
  arr.forEach(o=>{
    const row=tb.insertRow(); row.setAttribute('data-obs',o.obs||'');
    row.insertCell(0).textContent=o.numero;
    createEditableCell(row,1,o.nome);
    createEditableCell(row,2,o.telefone);
    createEditableCell(row,3,o.objetos);
    createEditableCell(row,4,o.entrada);
    createEditableCell(row,5,o.volta);
    createEditableCell(row,6,o.valor);

    /* --- Coluna Pagou --- */
    const c7=row.insertCell(7);
    const selPay=document.createElement('select');
    ["Nao pago","Sinal","Pago"].forEach(t=>{
      const op=document.createElement('option');op.value=t;op.textContent=t;selPay.appendChild(op);
    });
    selPay.value=o.pagou||"Nao pago";
    const bullet=document.createElement('span'); bullet.className='pay-bullet'; c7.appendChild(selPay); c7.appendChild(bullet);
    function updBullet(v){bullet.style.backgroundColor = v==="Nao pago"?"#f00":v==="Sinal"?"#ff0":v==="Pago"?"#0f0":"transparent";}
    updBullet(selPay.value);
    selPay.onchange=()=>{updBullet(selPay.value); salvarNoGoogle();};

    /* --- Coluna Status --- */
    const c8=row.insertCell(8);
    const selSt=document.createElement('select');
    ["EM ORÇAMENTO","EM CONSERTO","CONCLUIDO"].forEach(t=>{
      const op=document.createElement('option');op.value=t;op.textContent=t;selSt.appendChild(op);
    });
    selSt.value=o.status||"EM CONSERTO"; selSt.setAttribute('data-prev',selSt.value);
    selSt.onchange=function(){
      if(this.value==="CONCLUIDO" && selPay.value!=="Pago"){
        alert("O cliente precisa pagar para concluir.");
        this.value=this.getAttribute('data-prev');return;
      }
      if(confirm("Confirmar mudar para "+this.value+"?")){
        this.setAttribute('data-prev',this.value);
        updateRowStyleStatus(row,this.value); sortTable();
        salvarNoGoogle();
      }else this.value=this.getAttribute('data-prev');
    };
    c8.appendChild(selSt); updateRowStyleStatus(row,selSt.value);

    /* --- Coluna Ações --- */
    const c9=row.insertCell(9);
    const btnE=document.createElement('button');btnE.textContent='Editar';btnE.style.marginRight='5px';
    let editing=false;
    btnE.onclick=()=>{
      if(!editing){
        editing=true;btnE.textContent='Salvar';
        [1,2,3,4,5,6].forEach(i=>makeCellEditable(row.cells[i]));
      }else{
        editing=false;btnE.textContent='Editar';
        [1,2,3,4,5,6].forEach(i=>finalizeCellEdit(row.cells[i]));salvarNoGoogle();
      }
    };
    const btnX=document.createElement('button');btnX.textContent='Excluir';btnX.style.marginRight='5px';
    btnX.onclick=()=>{if(confirm("Excluir este registro?")){row.remove();salvarNoGoogle();}};
    const btnP=document.createElement('button');btnP.textContent='Imprimir';btnP.onclick=()=>imprimirRegistro(row);
    c9.append(btnE,btnX,btnP);

    const num=parseInt(o.numero,10); if(num>=registroCount) registroCount=num+1;
  });
  sortTable();
}

/* --------- Ordenação --------- */
function sortTable(){
  const tb=document.querySelector('#lista-cadastros tbody');
  Array.from(tb.rows).sort((a,b)=>{
    const ra=getStatusRank(a.cells[8].querySelector('select').value);
    const rb=getStatusRank(b.cells[8].querySelector('select').value);
    if(ra!==rb) return ra-rb;
    return parseDate(a.cells[4].textContent)-parseDate(b.cells[4].textContent);
  }).forEach(r=>tb.appendChild(r));
}

/* --------- Leitura/Scraping da tabela --------- */
function lerTabelaCadastros(){
  return Array.from(document.querySelectorAll('#lista-cadastros tbody tr')).map(tr=>{
    const td=tr.querySelectorAll('td');
    return {
      numero: td[0].textContent,
      nome: td[1].textContent,
      telefone: td[2].textContent,
      objetos: td[3].textContent,
      entrada: td[4].textContent,
      volta: td[5].textContent,
      valor: td[6].textContent,
      pagou: td[7].querySelector('select').value,
      status: td[8].querySelector('select').value,
      obs: tr.getAttribute('data-obs')||''
    };
  });
}

/* --------- CRUD BÁSICO --------- */
function confirmarCadastro(){
  const nome=document.getElementById('cad-nome').value.trim();
  if(!nome){alert("Preencha o nome.");return;}

  const telefone=document.getElementById('cad-telefone').value;
  const servico=document.getElementById('cad-servico').value;
  const obs=document.getElementById('cad-obs').value;
  const dias=document.getElementById('cad-dias-uteis').value;
  const isOrc=document.getElementById('orcamentoSim').checked;
  const valor=isOrc?"ORÇAMENTO":formatarValor(document.getElementById('cad-valor').value);

  const hoje=new Date();const d=String(hoje.getDate()).padStart(2,'0');const m=String(hoje.getMonth()+1).padStart(2,'0');const y=hoje.getFullYear();
  const entrada=`${d}/${m}/${y}`;

  let volta='';
  if(dias){const ret=new Date(hoje);ret.setDate(ret.getDate()+parseInt(dias,10));
    volta=`${String(ret.getDate()).padStart(2,'0')}/${String(ret.getMonth()+1).padStart(2,'0')}/${ret.getFullYear()}`;}

  const tb=document.querySelector('#lista-cadastros tbody');
  const row=tb.insertRow();
  row.setAttribute('data-obs',obs);
  row.insertCell(0).textContent=registroCount;
  createEditableCell(row,1,nome);createEditableCell(row,2,telefone);createEditableCell(row,3,servico);
  createEditableCell(row,4,entrada);createEditableCell(row,5,volta);createEditableCell(row,6,valor);

  /* replicar as mesmas colunas Pagou/Status/Ações do preencherTabela */
  preencherTabela([{numero:registroCount,nome,telefone,objetos:servico,entrada,volta,valor,
                    pagou:"Nao pago",status:isOrc?"EM ORÇAMENTO":"EM CONSERTO",obs}].concat(lerTabelaCadastros()));

  document.getElementById('btnNovaAba').style.display='block';
  document.getElementById('btnLimpar').style.background='yellow';

  window.print(); salvarNoGoogle();
}

function limparCadastro(){
  document.querySelectorAll('#cad-nome,#cad-telefone,#cad-servico,#cad-obs,#cad-dias-uteis,#cad-valor')
          .forEach(i=>i.value='');
  document.getElementById('orcamentoNao').checked=true; toggleValorField();
  document.getElementById('btnNovaAba').style.display='none';
  document.getElementById('btnLimpar').style.background='';
}

/* --------- Busca simples --------- */
function toggleSearch(){
  const b=document.getElementById('search-container');
  b.style.display=b.style.display==='none'?'block':'none';
}
function searchServices(){
  const term=document.getElementById('searchTerm').value.toLowerCase();
  document.querySelectorAll('#lista-cadastros tbody tr').forEach(r=>{
    r.style.display=r.textContent.toLowerCase().includes(term)?'':'none';
  });
}

/* --------- Impressão individual --------- */
function imprimirRegistro(row){
  document.getElementById('print-id').textContent=row.cells[0].textContent;
  document.getElementById('print-nome').textContent=row.cells[1].textContent;
  document.getElementById('print-telefone').textContent=row.cells[2].textContent;
  document.getElementById('print-servico').textContent=row.cells[3].textContent;
  document.getElementById('print-obs').textContent=row.getAttribute('data-obs')||'';
  document.getElementById('print-valor').textContent=row.cells[6].textContent;
  document.getElementById('print-data-entrada').textContent=row.cells[4].textContent;
  document.getElementById('print-data-retirada').textContent=row.cells[5].textContent;

  const g=parseDate(row.cells[5].textContent);g.setDate(g.getDate()+90);
  document.getElementById('print-garantia').textContent=
    `${String(g.getDate()).padStart(2,'0')}/${String(g.getMonth()+1).padStart(2,'0')}/${g.getFullYear()}`;

  window.print();
}

function abrirFolhaEmNovaAba(){
  const html=document.getElementById('folha-impressao').innerHTML;
  const w=window.open('','_blank');
  w.document.write(`<html><head><title>Folha</title></head><body>${html}</body></html>`);
  w.document.close();
}

/* --------- Comunicação com Apps Script --------- */
async function carregarDoGoogle(){
  try{
    const data=await fetch(SCRIPT_URL).then(r=>r.json());
    preencherTabela(data); console.log('Carregado do Google!');
  }catch(e){console.error(e);alert('Erro ao ler do Google: '+e);}
}
async function salvarNoGoogle(){
  try{
    const body=JSON.stringify(lerTabelaCadastros());
    const resp=await fetch(SCRIPT_URL,{method:'POST',body});
    const js=await resp.json();
    if(js.ok) console.log('Salvo!');
    else{console.error(js);alert('Erro do script: '+JSON.stringify(js));}
  }catch(e){console.error(e);alert('Falha ao salvar no Google: '+e);}
}
</script>
</body>
</html>
