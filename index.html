/**
 * Constantes Globais
 */
const NOME_PLANILHA = "Página1"; // Verifique se o nome da sua aba é este.
const SPREADSHEET = SpreadsheetApp.getActiveSpreadsheet();
const SHEET = SPREADSHEET.getSheetByName(NOME_PLANILHA);

/**
 * Esta função é chamada para CARREGAR os dados.
 */
function doGet(e) {
  try {
    const data = SHEET.getDataRange().getValues();
    const headers = data.shift();
    const json = [];

    data.forEach(row => {
      let entry = {};
      row.forEach((value, index) => {
        if (headers[index]) {
          entry[headers[index]] = value;
        }
      });
      json.push(entry);
    });

    return ContentService.createTextOutput(JSON.stringify(json)).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log(err.toString());
    return ContentService.createTextOutput(JSON.stringify({ "ok": false, "error": err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Esta função é chamada para SALVAR os dados. (VERSÃO CORRIGIDA)
 */
function doPost(e) {
  try {
    const cadastros = JSON.parse(e.postData.contents);

    // Limpa os dados antigos com segurança
    if (SHEET.getLastRow() > 1) {
      SHEET.getRange(2, 1, SHEET.getLastRow() - 1, SHEET.getLastColumn()).clearContent();
    }

    // Escreve os novos dados
    if (cadastros && cadastros.length > 0) {
      const headers = SHEET.getRange(1, 1, 1, SHEET.getLastColumn()).getValues()[0];
      const dataToSave = cadastros.map(obj => headers.map(header => obj[header] || ""));
      SHEET.getRange(2, 1, dataToSave.length, dataToSave[0].length).setValues(dataToSave);
    }

    return ContentService.createTextOutput(JSON.stringify({ "ok": true }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log(err.toString());
    return ContentService.createTextOutput(JSON.stringify({ "ok": false, "error": err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
