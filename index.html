<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ordem de Servi√ßo - PONTO 17</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --whatsapp-color: #25D366;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --concluido-bg: #e0f7da;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #e9ecef; margin: 0; padding: 20px;
        }
        .container { max-width: 1200px; margin: auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid var(--light-gray); padding-bottom: 10px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; color: #555; }
        input:not([type=checkbox]), input:not([type=radio]), textarea, select { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        .button-group { display: flex; gap: 10px; align-items: center; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: .9rem; font-weight: 600; transition: all .2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-toggle { background-color: #f0f0f0; color: #333; border: 1px solid var(--border-color); }
        .btn-toggle.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-whatsapp { background-color: var(--whatsapp-color); color: white; }
        .btn-whatsapp.clicked { background-color: var(--secondary-color); cursor: not-allowed; }
        .actions-bar { margin-top: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        tbody tr.concluido { background-color: var(--concluido-bg) !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; position: relative; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .status-dot.nao-pago { background-color: var(--danger-color); }
        .status-dot.sinal { background-color: var(--warning-color); }
        .status-dot.pago { background-color: var(--success-color); }
        
        @media print {
            body > *:not(#printModal) { display: none; }
            #printModal { position: absolute; left: 0; top: 0; width: 100%; height: auto; display: block !important; background-color: white; overflow: visible; }
            .modal-content { box-shadow: none; border: none; width: 100%; margin: 0; padding: 0; }
            .modal-header { display: none; }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <h1>Sistema de Ordem de Servi√ßo - PONTO 17</h1>
        <form id="serviceForm"></form>
        <div id="listContainer"></div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close-button" id="closeEditModal">&times;</span><h2>Editar Ordem de Servi√ßo</h2></div>
            <form id="editForm">
                <input type="hidden" id="editID" name="ID"><input type="hidden" id="editDataEntrada" name="DataEntrada"><input type="hidden" id="editDataPrevistaVolta" name="DataPrevistaVolta"><input type="hidden" id="editOrcamentoEnviado" name="OrcamentoEnviado">
                <div class="form-grid">
                    <div class="form-group"><label for="editNome">Nome:</label><input type="text" id="editNome" name="Nome" required></div>
                    <div class="form-group"><label for="editTelefone">Telefone:</label><input type="tel" id="editTelefone" name="Telefone" required></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label for="editObjetos">Objetos:</label><input type="text" id="editObjetos" name="Objetos" required></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label for="editDescricaoServico">Descri√ß√£o do servi√ßo:</label><textarea id="editDescricaoServico" name="DescricaoServico"></textarea></div>
                    <div class="form-group"><label for="editPrazoDias">Prazo (dias):</label><input type="text" id="editPrazoDias" name="PrazoDias"></div>
                    <div class="form-group"><label for="editValor">Valor (R$):</label><input type="text" id="editValor" name="Valor" required></div>
                    <div class="form-group"><label for="editPagou">Status Pagamento:</label><select id="editPagou" name="Pagou"><option value="Nao pago">Nao pago</option><option value="Sinal">Sinal</option><option value="Pago">Pago</option></select></div>
                    <div class="form-group"><label for="editStatus">Status Servi√ßo:</label><select id="editStatus" name="Status"><option value="EM OR√áAMENTO">EM OR√áAMENTO</option><option value="EM CONSERTO">EM CONSERTO</option><option value="CONCLUIDO">CONCLUIDO</option></select></div>
                </div>
                <div class="actions-bar">
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                    <button type="button" id="whatsappBtn" class="btn btn-whatsapp">ENVIAR OR√áAMENTO üì≤</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="printModal" class="modal"></div>
    <script>
        // --- IN√çCIO DO SCRIPT ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzK7vyqG_Cvqb62QX0yQ38j4-8MxVEBhu1ZDgCQOnHe9i66UIgoaQgNuOofzOLPBiSQBg/exec";
        // Restante do seu script JavaScript, colado aqui sem altera√ß√µes na l√≥gica principal
        // ... (c√≥digo anterior) ...

        // --- L√≥gica do Bot√£o WhatsApp ---
        const whatsappBtn = document.getElementById('whatsappBtn');
        
        function updateWhatsappButtonUI() {
            const orcamentoEnviado = whatsappBtn.dataset.orcamentoEnviado;
            if (orcamentoEnviado === 'SIM') {
                whatsappBtn.classList.add('clicked');
                whatsappBtn.textContent = 'OR√áAMENTO ENVIADO ‚úÖ';
                whatsappBtn.disabled = true;
            } else {
                whatsappBtn.classList.remove('clicked');
                whatsappBtn.textContent = 'ENVIAR OR√áAMENTO üì≤';
                whatsappBtn.disabled = false;
            }
        }

        whatsappBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editID').value;
            const nome = document.getElementById('editNome').value;
            const objeto = document.getElementById('editObjetos').value;
            const desc = document.getElementById('editDescricaoServico').value;
            const valorStr = document.getElementById('editValor').value;
            let telefone = document.getElementById('editTelefone').value.replace(/\D/g, '');

            if (telefone.length < 10) {
                alert('N√∫mero de telefone inv√°lido.');
                return;
            }
            if (!telefone.startsWith('55')) {
                telefone = '55' + telefone;
            }

            const mensagem = `Ol√°, ${nome}! Tudo bem?\nSegue o or√ßamento para o servi√ßo do seu ${objeto}:\n\nüîß Servi√ßo: ${desc}\nüíµ Valor total: R$ ${valorStr}\n\nPara autorizar o servi√ßo √© necess√°rio o pagamento de 50% do valor total.\nO pagamento pode ser efetivado em nossa loja ou pelo nosso pix.\n\nNome da empresa: Silva e Bravim LTDA\nChave pix: 39.783.774/0001-71\n\nAo realizar o pagamento envie o comprovante e uma mensagem informando que realizou o pagamento. \n\n‚ö†Ô∏è Aparelhos N√ÉO retirados em at√© 90 dias (aprovados ou n√£o) ser√£o sucateados.\n\nüìÖ Previs√£o de entrega: 5 dias √∫teis ap√≥s a confirma√ß√£o do pagamento (pode variar conforme o servi√ßo).\n\nQualquer d√∫vida, estou √† disposi√ß√£o.\nAtenciosamente,  \nPonto 17`;

            const whatsappURL = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;
            
            window.open(whatsappURL, '_blank');
            
            // Marca como enviado no backend
            const result = await fetchFromApi('markBudgetAsSent', { method: 'POST', body: new URLSearchParams({ id }) });
            if (result) {
                whatsappBtn.dataset.orcamentoEnviado = 'SIM';
                updateWhatsappButtonUI();
                // Atualiza o dado local para refletir na tabela principal
                const service = allServices.find(s => s.ID === id);
                if (service) service.OrcamentoEnviado = 'SIM';
            }
        });

        // Modifica√ß√£o na l√≥gica de Edi√ß√£o para preparar o bot√£o do WhatsApp
        tableBody.addEventListener('click', async e => {
            const target = e.target.closest('button');
            if (!target) return;
            const action = target.dataset.action;
            const id = target.dataset.id;
            
            if (action === 'edit') {
                const result = await fetchFromApi('getServiceById', { params: { id } });
                if (result) {
                    const service = result.data;
                    // Preenche o formul√°rio de edi√ß√£o
                    for (const key in service) {
                        const input = document.getElementById(`edit${key}`);
                        if (input) input.value = service[key];
                    }
                    document.getElementById('editValor').value = formatCurrency(String(service.Valor));
                    
                    // Configura o bot√£o do WhatsApp
                    whatsappBtn.dataset.orcamentoEnviado = service.OrcamentoEnviado || 'N√ÉO';
                    updateWhatsappButtonUI();
                    
                    editModal.style.display = 'block';
                }
            } else if (action === 'delete') {
                // ... (c√≥digo de exclus√£o sem altera√ß√µes)
            } else if (action === 'print') {
                // ... (c√≥digo de impress√£o sem altera√ß√µes)
            }
        });

        // Cole aqui o restante do seu script JavaScript, que gerencia os formul√°rios e a tabela.
        // O c√≥digo anterior a esta se√ß√£o deve ser mantido como estava.
    </script>
</body>
</html>
